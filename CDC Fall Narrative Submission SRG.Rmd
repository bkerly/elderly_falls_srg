---
title: "CDC Fall Narrative Submission"
author: "Salish Research Group"
date: "`r Sys.Date()`"
output: 
html_document:
  code_folding: hide
---

# TKTK: This is the Title of Our Submission

***Salish Research Group***

*Brian K Erly, MD MPH*

*Steven J Erly, PhD MPH*

[salishresearchgroup.com](salishresearchgroup.com "Salish Research Group Homepage")

[salishresearchgroup\@gmail.com](mailto:email@example.com "Salish Research Group Email")

## Table of Contents

TKTK

```{r setup, include = FALSE}

#Set Up Environment

## Load packages
library(tidyverse)
library(ggthemes)
library(lubridate)
library(gridExtra)
library(MASS)
library(episensr)

## Set grraph themes
#TKTK
```

## Part 1: Expert Panel

### Methods

In order to ascertain key factors and domains resulting in medically significant falls in persons over 65, we convened a panel of physician experts to participate in a two-step process, involving both a structured interview and a follow up questionnaire.

Participants were solicited from across a range of specialities, including emergency/urgent care, medical, and surgical roles. Participants were asked to commit to a 15 minute interview and 10 minute follow up questionnaire. All participants who completed both the interview and questionnaire received a small gift (value \<\$50).

The initial interview commenced with a review of the project and goals. Next, each panel member was asked about their practice context and the percentage of patients who they see for fall-related complaints. This was followed up with a series of questions designed to elicit causes of severe falls in persons over 65, including causes which make a fall more likely and causes which might cause a fall to be more medically consequential.

Each panel member then received a follow up questionnaire as a google form. This follow up questionnaire was centered around two themes: defining injury patterns associated with fragility / frailty, and ranking the most important factors leading to falls.Â 

For each of 29 injury patterns, participants were asked to select the degree to which each was associated with frailty in elderly fall patients. Each injury pattern was ranked from 1 ("Not associated with frailty") to 4 ("Pathognomonic for frailty").

Next, each participant was asked to rank 10 factors in order of their association with risk of serious injury in patients over 65 years old. Participants were instructed to place the factors in order, with no ties.

### Results

Seven physicians were contacted to participate in the panel, of whom 5 elected to participate (71.4%). All participants who agreed to participate in the initial panel completed both the structured interview and follow up questionnaire. The panel was composed of one physician each from the following specialties; emergency medicine, otolaryngology, neurosurgery, orthopedic surgery, and inpatient medicine. All participants were board-eligible or board-certified in their specialty.

During the structured interview, panel members spent a median of 7.5% of their practice time treating patients due to medical consequences of falls (range 2.5-27.5%).

```{r Practice time}
# Load practice time data
practice_time <- read_csv("Data/Practice Time.csv")

# Output plot
ggplot(data = practice_time,aes(x=reorder(respondant,-mid))) +
  #geom_point(aes(y=mid))+
  geom_errorbar(aes(ymin= low,ymax = high))+
  theme_minimal()+
  ylab("")+
  xlab("")
# TKTK make graph prettier.

```

Panel members identified eight classes of medication associated with falls, as well as nine underlying medical conditions which might lead to more severe falls in an elderly person (Table 1).

|                                    |              |             |
|------------------------------------|--------------|-------------|
| **Medication / Therapeutic Class** | **Mentions** | **Percent** |
| Opioids / Pain Medications         | 5            | 100%        |
| Polypharmacy / Drug Interaction    | 3            | 60%         |
| Alcohol                            | 2            | 40%         |
| Antihypertensives                  | 2            | 40%         |
| Anticholinergics                   | 2            | 40%         |
| Anxiolytics                        | 2            | 40%         |
| Antidiabetic                       | 1            | 20%         |
| Blood thinners                     | 1            | 20%         |

: Table 1: Medication classes identified as associated with falls during unstructured clinician panel interviews.

|                                   |              |             |
|-----------------------------------|--------------|-------------|
| **Underlying Medical Conditions** | **Mentions** | **Percent** |
| Deconditioning                    | 3            | 60%         |
| Dementia                          | 2            | 40%         |
| Gait disturbance                  | 2            | 40%         |
| Neuropathy                        | 2            | 40%         |
| Balance disorder                  | 1            | 20%         |
| Hypotension or Syncope            | 1            | 20%         |
| Visual Changes                    | 1            | 20%         |
| Arthritis                         | 1            | 20%         |
| Renal disease                     | 1            | 20%         |

: Table 2: Medication classes identified as associated with falls during unstructured clinician panel interviews.

When responding to the follow up questionnaire, the panel identified pelvic fractures as the injury most associated with fragility, followed by fracture of the native hip joint and fracture of the femur. Overall, 20 of the 29 injury patterns examined had a median ranking of 3 ("Highly suggestive of frailty") or 4 ("Pathognomonic for frailty; would not occur in a non-frail person after a fall").

```{r injury patterns, include = TRUE}

# Load injury pattern data
injury_patterns_import <- read_csv("Data/injury interview data.csv")

injury_patterns <- injury_patterns_import %>%
  # remove brackets
  mutate(Injury = stringi::stri_replace_all_fixed(Injury,"[","")) %>%
  mutate(Injury = stringi::stri_replace_all_fixed(Injury,"]","")) %>%
  
  arrange(desc(Mean)) %>%
  
  mutate(Injury = factor(Injury,
                         levels = unique(Injury))) %>%
  
  # remove summary stats
  dplyr::select(-Median,-Mean) %>%
  # # convert to long format
  pivot_longer(-Injury,names_to = "respondent",values_to = "ranking") %>%
  # convert ranking numeric to text
  mutate(ranking = 
           factor(ranking, 
                  levels = c(4,3,2,1),
                  labels = c("Pathognomonic for frailty",
                             "Highly suggestive of frailty",
                             "Suspicious for frailty",
                             "Not assocaited with frailty"))
  ) %>%
  mutate(order = 
           as.numeric(Injury))

ggplot(data = injury_patterns) +
  coord_flip()+
  geom_bar(aes(x=reorder(Injury,-as.numeric(Injury)),fill=ranking))+
  theme_minimal()+
  ylab("")+
  xlab("") + 
  theme(legend.position = "bottom",
        legend.title = element_blank())+
  scale_fill_grey()

```

Panelists also ranked fall energy as the most important factor associated with the likelihood of a fall related injury (median ranking 1/10), followed by fragility (median ranking 2/10). Intoxication, inappropriate medication or overmedication, medical conditions affecting stability/balance, and cardiac and neurovascular conditions affecting consciousness were all tied for third-place (median ranking 4/10).

```{r fall factors, include = TRUE}

# Load injury pattern data
fall_factor_import <- read_csv("Data/factor interview data.csv")

fall_factors <- fall_factor_import %>%
  # remove brackets
  mutate(Factor = stringi::stri_replace_all_fixed(Factor,"[","")) %>%
  mutate(Factor = stringi::stri_replace_all_fixed(Factor,"]","")) %>%
  
  arrange(desc(Median)) %>%
  
  mutate(Factor = factor(Factor,
                         levels = unique(Factor))) %>%
  dplyr::select(-Median,-Mean) %>%
  # # convert to long format
  pivot_longer(-Factor,names_to = "respondent",values_to = "ranking")
  

fall_factors %>%
  ggplot(aes(x=Factor,y=ranking))+
  geom_boxplot(fill="grey")+
  coord_flip()+
  xlab("")+
  ylab("Importance")+
  theme_minimal()

```

## Part 2: Analytic Approach

### Methods

We next worked to identify the factors most correlated with fall severity in the fall narrative. For this stage of the analysis, we focused only on the factors which were able to be identified within the narrative. These factors were:

-   Fall Energy
-   Intoxication
-   Fragility
-   Unfamiliar Activity
-   Cognition
-   Environment
-   Consciousness

First, we manually coded phrases within a randomly selected subset of fall narratives which correlated to the factors selected. We then used these factors to...

*Note: Steve, this is where you need to write some things.*

### Results

```{r part 2 import data}

  my_data <- read.csv("Data/primary_data.csv")
  kw<-read.csv("Data/keyword import2.csv")
  topics<-c("Fall.Energy", "Intoxication", "Fragility", "Unfamiliar.Activity",
               "Cognition", "Environment", "Consciousness")

```

We identified 245 total keywords for the seven factors examined (range 5-35 keywords per factor). These were matched to 115,128 patient narratives.

```{r Estimating Thematic Saturation}


  
#Part 1: Estimating Thematic Saturation  
        
      SatEst<-function(Topic){
      kwlist<-kw[,Topic]
      kwlist2<-kwlist[nzchar(kwlist)]
        
      #Loop to search each note for each keywords.  Outputs True/False matrix with one row per note and one column per keyword
         md<-list()
         df<-data.frame(V1=numeric(nrow(my_data)))
          for  (i in 1:length(kwlist2)) {
            
              df[,i]<-str_detect(my_data$narrative, kwlist2[i])
              md[i]<-min(which(df[,i]==TRUE))
             # print(i) Stopping this indicator because it's just printing the numbers, and I know like all the numbers already.
          }
        
          
      #Mathematical Model, https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7200005/
         #Part 1: Estimate of Overall Saturation
         
         N<-500
         T1<-sum(df[1:500,])/500
         NTerms<-length(kwlist2)
         A<-((N-1)*T1*NTerms)/(N*T1-NTerms)
         Est<-tail(round(NTerms/A*100),1)
      
         #Part 2: Theoretical Model of Saturation
         b<-(NTerms-N*T1)/((1-N)*NTerms)
         N<-seq(1:500)
         Tn<-A*b*N/(1+b*(N-1))
         sim<-data.frame(V1=seq(1:500),cumsum=Tn,Label="Simulated")
         
      #Plot of observed data vs model      
         #Dataframe indicating at which note each keyword was first observed 
           md1<-do.call(rbind.data.frame, md)%>%mutate(ind=1)%>%rename(V1=1)
           md2<-data.frame(V1=seq(1,500,1))%>%left_join(md1)%>%
             mutate(ind=coalesce(ind,0))%>%
             group_by(V1)%>%
             summarize(ind=sum(ind))%>%
             ungroup()%>%
             mutate(cumsum=cumsum(ind))
           real<-md2%>%dplyr::select(V1,cumsum)%>%mutate(Label="Observed")   
      
        #Bringing Together Simulated And Observed Data for Plot
        full<-rbind(real,sim)  
        plot<-ggplot(data=full)+
           geom_line(aes(x=V1,y=cumsum,group=Label, color=Label))+
           theme(axis.ticks = element_blank(),
                 panel.grid.minor = element_blank(),
                 panel.grid.major = element_blank(),
                 panel.background = element_blank(),
                 plot.title = element_text(hjust = 0.5)
           )+ 
           labs(y = "Keywords Identified", x = "Records Reviewed", colour = "", title=Topic)
         
        
      output<-list(Topic,Est,plot)  
      return(output)
      }
  

v1<-SatEst("Fall.Energy")
v2<-SatEst("Intoxication")
v3<-SatEst("Fragility")
v4<-SatEst("Unfamiliar.Activity")
v5<-SatEst("Cognition")
v6<-SatEst("Environment")
v7<-SatEst("Consciousness")

#Print Saturation
data.frame(Topic=topics, Saturation=c(v1[[2]],v2[[2]],v3[[2]],v4[[2]],
                                      v5[[2]], v6[[2]],v7[[2]]))

```

```{r Plotting Thematic Saturation}


#Print Plots
grid.arrange(v1[[3]], v2[[3]], v3[[3]], v4[[3]],
             v7[[3]], v6[[3]], v7[[3]],nrow = 7)

```

```{r Part 2: Epi #Regression Model}


  #Function to Create Indicators for The Presence of Each Keyword
  lps<-function(ind){
      kwlist<-unique(kw[ind])
      kwlist<-kwlist[(kwlist=='')==FALSE]
      md<-list()
      df<-data.frame(V1=numeric(nrow(my_data)))
 
              for  (i in 1:length(kwlist)) {
          
          df[,i]<-str_detect(my_data$narrative, kwlist[i])
          md[i]<-min(which(df[,i]==TRUE))
          #print(i)
          
        }
    
      col<-apply(df, 1, max, na.rm=TRUE)
      return(col)
  }


Fall.Energy<-lps(1)
Intoxication<-lps(2)
Fragility<-lps(3)
Unfamiliar.Activity<-lps(4)
Cognition<-lps(5)
Environment<-lps(6)
Consciousness<-lps(7)

#Outcome Indicator
Outcome<-ifelse(my_data$disposition>3,1,0)

m1 <- glm.nb(Outcome ~ Fall.Energy+Intoxication+Fragility+Unfamiliar.Activity+
                               Cognition+Environment+Consciousness
             #+NLength
             #NLength isn't a declared value, as far as I can tell.
             )

df<-data.frame(Fall.Energy,Intoxication,Fragility,Unfamiliar.Activity,
                Cognition,Environment,Consciousness,Outcome)



QBA<-function(i,Exposure,Label){
  
sens<-i[[2]]/100
Case_Exposed<-df[Exposure==1 & Outcome==1,]%>%nrow()
Case_Unexposed<-df[Exposure==0 & Outcome==1,]%>%nrow()
Control_Exposed<-df[Exposure==1 & Outcome==0,]%>%nrow()
Control_Unexposed<-df[Exposure==0 & Outcome==0,]%>%nrow()


g<-episensr::misclassification(matrix(c(Case_Exposed, Case_Unexposed, Control_Exposed, Control_Unexposed),
                         dimnames = list(c("Case", "Control"),
                                         c("Exposure +", "Exposure - ")),
                         nrow = 2, byrow = TRUE),
                  type = "exposure",
                  bias_parms = c(sens, sens, 0.97, 0.97))

obs<-t(g$obs.measures[1,])
adj<-t(g$adj.measures[2,])

output2<-cbind(Label,obs,adj)
colnames(output2)<-c("Label", "UnadjustedRR", "2.5%" ,"97.5%", "AdjustedRR", "2.5%" ,"97.5%")
return(output2)
}

```

```{r QBAs}

QBA(v1,Fall.Energy,"Fall.Energy")
QBA(v2,Fall.Energy,"Intoxication")
QBA(v3,Fragility,"Fragility")
QBA(v4,Unfamiliar.Activity,"Unfamiliar.Activity")

```

I kind of think this should be a graph, maybe like one of those meta analysis graphs where you can see all the little studies and if they cross 0 or 1 or whatever.
